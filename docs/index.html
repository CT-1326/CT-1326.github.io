<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <!--jQuery 로드-->
        <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
        <style>
            .area {
                position: absolute;
                background: #fff;
                border: 1px solid #888;
                border-radius: 3px;
                font-size: 12px;
                top: -5px;
                left: 15px;
                padding: 2px;
            }
            .info {
                font-size: 12px;
                padding: 5px;
            }
            .info .title {
                font-weight: bold;
            }
        </style>
        <title>Sample Polygon</title>
    </head>
    <body>
        <div id="map" style="width:100%;height:900px;"></div>
        <!--KAKAO-MAP 로드-->
        <script
            type="text/javascript"
            src="//dapi.kakao.com/v2/maps/sdk.js?appkey=2befa4c2ccbf24ac6c3bec24f23abb28"></script>
        <script>
            let map = new kakao
                .maps
                .Map(document.getElementById('map'), {
                    // 지도를 표시할 div
                    center: new kakao
                        .maps
                        .LatLng(37.5642135, 127.0016985), // 초기 지도의 중심좌표
                    level: 8 // 초기 지도의 확대 레벨
                });
            let customOverlay = new kakao
                .maps
                .CustomOverlay({}); // 읍면동 이름을 표시할 오버레이

            // 일반 지도와 스카이뷰로 지도 타입을 전환할 수 있는 지도타입 컨트롤을 생성합니다
            var mapTypeControl = new kakao
                .maps
                .MapTypeControl();

            // 지도에 컨트롤을 추가해야 지도위에 표시됩니다 kakao.maps.ControlPosition은 컨트롤이 표시될 위치를 정의하는데
            // TOPRIGHT는 오른쪽 위를 의미합니다
            map.addControl(mapTypeControl, kakao.maps.ControlPosition.TOPRIGHT);

            // 지도 확대 축소를 제어할 수 있는  줌 컨트롤을 생성합니다
            var zoomControl = new kakao
                .maps
                .ZoomControl();
            map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);

            // 서울 읍면동 데이터 파일을 입력 받아 폴리곤 렌더링
            $.getJSON(
                "https://raw.githubusercontent.com/BSAA7567/BSAA7567.github.io/master/json/seou" +
                        "l.geojson",
                function (params) {
                    let data = params.features;
                    let coordinates = [];
                    let name = '';
                    $.each(data, function (index, val) {
                        coordinates = val.geometry.coordinates;
                        name = val.properties.emd_kor_nm;
                        // console.log(coordinates, name);
                        display(coordinates, name);
                    });
                }
            );

            let polygons = []; // 확대 시 폴리곤 제거를 위한 배열

            function display(coordinates, name) {
                let path = [];
                let points = [];

                $.each(coordinates[0], function (index, coordinate) {
                    for (let index = 0; index < coordinate.length; index++) {
                        let point = new Object();
                        point.x = coordinate[index][1];
                        point.y = coordinate[index][0];
                        points.push(point)
                        path.push(new kakao.maps.LatLng(coordinate[index][1], coordinate[index][0]))
                    }
                });
                // 읍면동 하나 당 폴리곤 생성
                let polygon = new kakao
                    .maps
                    .Polygon({
                        map: map,
                        path: path,
                        strokeWeight: 2,
                        strokeColor: '#004c80',
                        strokeOpacity: 0.8,
                        // strokeStyle: 'dashed',
                        fillColor: '#fff',
                        fillOpacity: 0.7
                    });
                polygons.push(polygon);

                // 다각형에 mouseover 이벤트를 등록하고 이벤트가 발생하면 폴리곤의 채움색을 변경합니다 지역명을 표시하는 커스텀오버레이를 지도위에
                // 표시합니다
                kakao
                    .maps
                    .event
                    .addListener(polygon, 'mouseover', function (mouseEvent) {
                        polygon.setOptions({fillColor: '#09f'});

                        customOverlay.setContent('<div class="area">' + name + '</div>');

                        customOverlay.setPosition(mouseEvent.latLng);
                        customOverlay.setMap(map);
                    });

                // 다각형에 mousemove 이벤트를 등록하고 이벤트가 발생하면 커스텀 오버레이의 위치를 변경합니다
                kakao
                    .maps
                    .event
                    .addListener(polygon, 'mousemove', function (mouseEvent) {

                        customOverlay.setPosition(mouseEvent.latLng);
                    });

                // 다각형에 mouseout 이벤트를 등록하고 이벤트가 발생하면 폴리곤의 채움색을 원래색으로 변경합니다 커스텀 오버레이를 지도에서 제거합니다
                kakao
                    .maps
                    .event
                    .addListener(polygon, 'mouseout', function () {
                        polygon.setOptions({fillColor: '#fff'});
                        customOverlay.setMap(null);
                    });

                // 폴리곤 클릭 시 해당 읍면동으로 확대 줌
                kakao
                    .maps
                    .event
                    .addListener(polygon, 'click', function () {
                        map.setLevel(3, {
                            anchor: centroid(points),
                            animate: {
                                duration: 350
                            }
                        });
                        deletePolygon(polygons);
                    });

                // 폴리곤 중심좌표를 구하는 centroid 알고리즘 함수
                function centroid(points) {
                    let i,
                        j,
                        len,
                        p1,
                        p2,
                        f,
                        area,
                        x,
                        y;

                    area = x = y = 0;

                    for (i = 0, len = points.length, j = len - 1; i < len; j = i++) {
                        p1 = points[i];
                        p2 = points[j];

                        f = p1.y * p2.x - p2.y * p1.x;
                        x += (p1.x + p2.x) * f;
                        y += (p1.y + p2.y) * f;
                        area += f * 3;
                    }

                    return new kakao
                        .maps
                        .LatLng(x / area, y / area);
                }

                // 클릭 이벤트로 지도 확대 시 전체 폴리곤 제거
                function deletePolygon(polygons) {
                    for (let index = 0; index < polygons.length; index++) {
                        polygons[index].setMap(null);
                    }
                    // polygons = [];
                }
            };
            kakao
                .maps
                .event
                .addListener(map, 'zoom_changed', function () {
                    // 지도의 현재 레벨을 얻어옵니다
                    var level = map.getLevel();
                    console.log(level);

                    if (level >= 5) {
                        for (let index = 0; index < polygons.length; index++) {
                            polygons[index].setMap(map);
                        }
                    }

                    if (level <= 3) {
                        for (let index = 0; index < polygons.length; index++) {
                            polygons[index].setMap(null);
                        }
                    }
                });
        </script>
    </body>
</html>